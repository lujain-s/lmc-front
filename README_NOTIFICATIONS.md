# نظام الإشعارات - LMC

## نظرة عامة

يشرح هذا المستند بالتفصيل كيفية عمل نظام الإشعارات في مشروع الواجهة الأمامية LMC، بدءًا من تحميل التطبيق وحتى استقبال الإشعار وعرضه للمستخدم.

---

## 1. **تهيئة فايربيز وتسجيل Service Worker**

- عند تحميل التطبيق، يتم تهيئة فايربيز باستخدام الإعدادات الموجودة في `src/firebase.js`.
- يجب أن يكون ملف الخدمة `firebase-messaging-sw.js` موجودًا في مجلد `public/` حتى تعمل الإشعارات في الخلفية.

---

## 2. **الحصول على توكن FCM**

- يتم استدعاء الدالة `requestForToken` في `src/firebase.js` (عادةً عند بدء التطبيق أو بعد تسجيل الدخول).
- تطلب هذه الدالة توكن الجهاز من خدمة Firebase Cloud Messaging (FCM).
- إذا تم الحصول على توكن وكان مختلفًا عن التوكن المخزن مسبقًا في `localStorage`:
  - يتم حفظه في `localStorage` تحت المفتاح `firebase_token`.
  - يتم إرساله إلى الباكند عبر طلب POST إلى `/api/editFirebaseToken` (مع توكن المستخدم في الهيدر).
- هذا يضمن أن الباكند لديه دائمًا أحدث توكن لجهاز المستخدم لإرسال الإشعارات.

---

## 3. **جلب الإشعارات وعدد الغير مقروء**

- يستخدم مكون Navbar مكتبة React Query لجلب:
  - قائمة الإشعارات من `/api/getNotifications` (عند فتح القائمة المنسدلة).
  - عدد الإشعارات غير المقروءة من `/api/getUnreadCount` (دائمًا إذا كان المستخدم مسجلاً).
- يظهر عدد الإشعارات غير المقروءة كشارة (badge) على أيقونة الجرس. إذا لم توجد إشعارات غير مقروءة، تختفي الشارة.

---

## 4. **عرض الإشعارات**

- عند نقر المستخدم على أيقونة الجرس، تظهر قائمة منسدلة تعرض أحدث الإشعارات (العنوان، المحتوى، التاريخ).
- القائمة مصممة لتناسب هوية الموقع وتدعم التمرير إذا كانت الإشعارات كثيرة.

---

## 5. **استقبال إشعار جديد (تحديث فوري)**

- يستمع التطبيق للإشعارات الفورية (foreground) باستخدام `onMessageListener` من `src/firebase.js`.
- عند وصول إشعار جديد من فايربيز:
  - يتم إعادة جلب عدد الإشعارات غير المقروءة تلقائيًا.
  - إذا كانت القائمة المنسدلة مفتوحة، يتم أيضًا إعادة جلب قائمة الإشعارات.
  - هذا يضمن أن واجهة المستخدم محدثة دومًا دون الحاجة لتحديث يدوي.

---

## 6. **Service Worker للإشعارات في الخلفية**

- وجود ملف `firebase-messaging-sw.js` في مجلد `public/` يتيح استقبال الإشعارات حتى لو لم يكن التطبيق في الواجهة أو كان مغلقًا.
- يمكن للباكند إرسال إشعارات مباشرة للجهاز باستخدام التوكن المخزن.

---

## 7. **ملخص سير العمل**

1. **تحميل التطبيق** → تهيئة فايربيز → تسجيل Service Worker.
2. **تسجيل دخول المستخدم** → استدعاء `requestForToken` → الحصول على توكن FCM → إرساله للباكند إذا كان جديدًا أو تغير.
3. **Navbar** يعرض دائمًا شارة بعدد الإشعارات غير المقروءة (إذا كان العدد > 0).
4. **فتح قائمة الإشعارات** → جلب وعرض القائمة في القائمة المنسدلة.
5. **وصول إشعار جديد** (عبر FCM) → تحديث الشارة والقائمة تلقائيًا في الواجهة.

---

## 8. **نقاط النهاية (Endpoints) المستخدمة**

- `POST /api/editFirebaseToken` — حفظ/تحديث توكن FCM في الباكند.
- `GET /api/getNotifications` — جلب قائمة الإشعارات.
- `GET /api/getUnreadCount` — جلب عدد الإشعارات غير المقروءة.

---

## 9. **ملاحظات وأفضل الممارسات**

- تأكد دائمًا من وجود ملف الخدمة في المسار الصحيح (`public/firebase-messaging-sw.js`).
- يجب إرسال توكن FCM للباكند بعد كل تسجيل دخول أو عند تغيّره.
- واجهة المستخدم تتحدث تلقائيًا عند وصول إشعار جديد، ما يوفر تجربة فورية للمستخدم.

---

لأي استفسار أو مشكلة، راجع الكود في `src/firebase.js` و`src/components/navbar/Navbar.js` أو تواصل مع فريق التطوير.
